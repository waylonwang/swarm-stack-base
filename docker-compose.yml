version: '3.4'

services:
  # Portainer nodes代理
  agent:
    image: portainer/agent:2.16.2
    networks:
      - network_cluster
    environment:
      AGENT_CLUSTER_ADDR: tasks.agent
      TZ: Asia/Shanghai
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
    deploy:
      mode: global
      placement:
        constraints: [node.platform.os == linux]

  # Portainer Swarm管理
  portainer:
    image: portainer/portainer-ce:2.16.2
    command: -H tcp://tasks.agent:9001 --tlsskipverify
    networks:
      - network_cluster
    ports:
      - target: 9000
        published: 9000
        protocol: tcp
        mode: host
    volumes:
      - homenas_portainer:/data
    env_file:
      # 容器内的全部环境变量，用于Portainer Stack Deploy构建services时对compose文件的解析
      # 具体Stack的docker-compose.yml文件中的环境变量，都可以直接使用这个文件中定义的用于Portainer容器的环境变量
      # 例如：所有docker-compose.yml中的TZ都可以直接定义为 TZ: ${TZ}
      - /data/.env
    deploy:
      labels:
        # 对外暴露容器服务
        - "traefik.enable=true"
        # 对外访问的路由地址，路由规则请参考官网
        # https://docs.traefik.io/routing/routers/
        - "traefik.http.routers.portainer.rule=Host(`swarm.cloudvalley.name`)"
        # 对外暴露的入口点
        - "traefik.http.routers.portainer.entrypoints=websecure"
        # 容器内的入口点，treafik无法获知你的服务的访问入口点
        # 所以你必须以此告诉Traefik
        # Traefik同时会在此对横向拓展的容器建立负载均衡
        # 更多见https://docs.traefik.io/routing/services/
        - "traefik.http.services.portainer.loadbalancer.server.port=9000"        
      mode: replicated
      replicas: 1
      placement:
        constraints: [node.role == manager, node.labels.type == nas]

networks:
  network_cluster:
    external: true

volumes:
  # 挂载NFS卷，用于Swarm集群node迁移时保持数据
  homenas_portainer:
    driver: local
    driver_opts:
      type: nfs
      o: addr=192.168.11.99,rw,nfsvers=4
      device: :/volume1/docker/swarm/base/portainer